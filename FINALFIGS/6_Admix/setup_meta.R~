###
### R script to setup metadata for pca and admixture analysis
### Uses a bamfile and metadata to classify points
###


#bf = "../../bamlists/alldata-subLi.bamlist"
bf = "../../bamlists/all.bamlist"
metaf = "../../gigas_bam_qualities.csv"
metal = "../../LiMetaData.csv"

##read data and merge bams with metadata


bams=readLines(bf)

meta=read.csv(metaf)
metali=read.csv(metal)

#print(meta$file)
print(dim(meta))



metali=metali[,-which(names(metali) %in% c("BioSample","SampleName","ReleaseDate","LoadDate","spots","bases","spots_with_mates","avgLength","size_MB","AssemblyName","download_path","Experiment","LibraryName","LibraryStrategy","LibrarySelection","LibrarySource","LibraryLayout","InsertSize","InsertDev","Platform","Model","SRAStudy","BioProject","Study_Pubmed_id","BioSample.y","SampleType","TaxID"))]
names(metali)[which(names(metali)=="Run")]="id"

#head(metali)

meta=rbind(meta[,c("pop","Region","id","Latitude","Longitude")],
	   metali[,c("pop","Region","id","Latitude","Longitude")])

bams <- gsub("/home/stranda/projects/oyster/sotka/roslin/bwa/out/","",bams)
bams <- gsub("/home/stranda/projects/oyster/LiSamples/roslin/bwa/out/","",bams)
bams <- gsub("_roslin","",bams)
bams <- gsub("_bwa.np.bam","",bams)

iddf = data.frame(id=bams,bforder=1:length(bams))

print(names(iddf))

iddf <- merge(iddf,meta,all.x=T)
iddf <- iddf[order(iddf$bforder),]

print("assembled dataframe")

iddf$Region = factor(as.character(iddf$Region), levels =
 c("Japan",  
 "Korea", "China", "NW America","soCal",  "Denmark", "Norway",  "Sweden", "Ireland", "France", "Spain", "Argentina", "Chile", "New Zealand","South Africa"))
iddf$Latitude[is.na(iddf$Latitude)]=0
iddf$Longitude[is.na(iddf$Longitude)]=0
print(unique(iddf$Region))
print(iddf)
